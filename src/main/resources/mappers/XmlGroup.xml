<?xml version="1.0" encoding="utf-8" ?>
<!-- Mypage 채팅  -->
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- Mapper 네임스페이스 설정 -->
<!-- 자바 쪽에서 이 Mapper를 호출할 때, web.model.mapper.community.GroupbulkbuyMapper 로 접근 -->
<mapper namespace="web.model.mapper.community.GroupbulkbuyMapper">

    <!--  [1] 방 참여 (insert or update)
         사용자가 방에 처음 들어갈 때 실행됨.
         - group_member 테이블에 (mno, bno) 저장
         - 이미 존재하면 active=1로 변경 (재참여)
         - joindate는 항상 NOW()로 갱신 -->
    <insert id="joinGroup" parameterType="map">
        INSERT INTO group_member (mno, bno, active, joindate)
        VALUES (#{mno}, #{bno}, 1, NOW())
            ON DUPLICATE KEY UPDATE active = 1, joindate = NOW();
    </insert>

    <!--  [2] 내가 참여중인 모임 목록 조회
         마이페이지에서 “내가 참여중인 방 보기” 눌렀을 때 실행됨.
         - group_member(gm) 기준으로, 회원번호(mno)에 해당하는 방 목록을 가져옴.
         - active = 1 (현재 참여중인 방만)
         - bulkbuygroup(b)와 members(m) 테이블을 JOIN하여
           방 제목, 내용, 작성자 이름, 참여 날짜까지 같이 조회 -->
    <select id="myGroups" parameterType="int" resultType="web.model.dto.community.GroupbulkbuyDto">
        SELECT
            b.bno,
            b.btitle,
            b.bcount,
            b.btotal,
            b.mno as host_mno ,
            b.bcontent,
            m.mname,
            gm.joindate
        FROM group_member gm
                 JOIN bulkbuygroup b ON gm.bno = b.bno
                 JOIN members m ON gm.mno = m.mno
        WHERE gm.mno = #{mno}
          AND gm.active = 1
    </select>

    <!--  [3] 방 퇴장 (update)
         사용자가 방을 나갈 때 실행됨.
         - 해당 회원(mno)이 참여중인 방(bno)의 active를 0으로 바꾸고,
           나간 날짜(leavedate)를 NOW()로 기록 -->
    <update id="leaveGroup" parameterType="map">
        UPDATE group_member
        SET active = 0,
            leavedate = NOW()
        WHERE mno = #{mno}
          AND bno = #{bno}
    </update>

    <!--  [중복 참여 여부 확인] -->
    <select id="joincount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM group_member
        WHERE mno = #{mno}
          AND bno = #{bno}
          AND active = 1
    </select>

    <!-- 방장 나가기 -->
    <update id="playgmnoout" parameterType="map">
        UPDATE group_member
        SET active = 0 ,
            leavedate = NOW()
        WHERE gmno = #{gmno}
        AND  bno = #{bno}
    </update>

    <!-- 방장 나가기 이후 방 전환 -->
    <!-- 1이 읽기모드 -->
    <update id="roomcheck" parameterType="map" >
        UPDATE bulkbuygroup
        SET read_only = 1
        WHERE bno = #{bno}
    </update>

    <!-- 방 읽기 모드 변경 -->
    <!-- 조건식 only값이 1(읽기) (참) 일시 성공 / (참) 아니면 실패 후 종료 -->
    <select id="roomlock" resultType="boolean">
        SELECT CASE WHEN read_only = 1 THEN true ELSE false END
        FROM bulkbuygroup
        WHERE bno = #{bno}
    </select>

</mapper>
